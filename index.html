<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="dns-prefetch" href="https://sjrhljtjgxjohkipxaky.supabase.co">
    <style>
        :root {
            /* Dark Theme Color Palette */
            --primary-bg: #0a0a0f;
            --secondary-bg: #111118;
            --tertiary-bg: #1a1a24;
            --card-bg: rgba(26, 26, 36, 0.95);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: rgba(99, 102, 241, 0.2);
            --border-hover: rgba(99, 102, 241, 0.4);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            --gradient-primary: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            --gradient-bg: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient-bg);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2.5rem 0;
            margin-bottom: 3rem;
            position: relative;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            padding: 2rem;
            margin-bottom: 3rem;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-bg);
            opacity: 0.05;
            border-radius: 1rem;
            z-index: -1;
        }

        .brand-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .logo-main {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            text-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
            line-height: 1;
        }

        .logo-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .brand-tagline {
            margin-top: 0.5rem;
        }

        .tagline-text {
            font-size: 0.75rem;
            color: var(--accent-primary);
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .counters {
            display: flex;
            gap: 1rem;
        }

        .counter {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 1.25rem 1.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-align: center;
            min-width: 120px;
        }

        .counter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .counter:hover::before {
            opacity: 0.05;
        }

        .counter:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }

        .counter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .counter-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            line-height: 1;
        }

        .operator-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .operator-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .operator-status {
            font-size: 0.75rem;
            color: var(--accent-success);
            font-weight: 500;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: var(--gradient-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
            color: white;
        }

        .nav-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            letter-spacing: 0.025em;
        }

        input,
        select,
        textarea,
        button {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--tertiary-bg);
        }

        button {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-xl);
        }

        .btn-danger {
            background: var(--accent-error);
            border-color: var(--accent-error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--accent-primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            padding: 0;
        }

        .btn-link:hover {
            color: var(--accent-secondary);
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
        }

        .card h3 {
            margin-bottom: 2rem;
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table th,
        .table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .table th {
            position: sticky;
            top: 0;
            background: var(--tertiary-bg);
            z-index: 10;
        }

        .table th {
            background: var(--tertiary-bg);
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .grade-badge {
            background: var(--accent-secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Status Indicators */
        .status {
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--secondary-bg) 25%, var(--tertiary-bg) 50%, var(--secondary-bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            height: 120px;
            border-radius: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-muted {
            color: var(--text-muted);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .container {
                padding: 1.5rem 1rem;
            }

            header {
                flex-direction: column;
                gap: 2rem;
                text-align: center;
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .brand-section {
                align-items: center;
            }

            .logo-main {
                font-size: 2rem;
            }

            .user-info {
                flex-direction: column;
                gap: 1.5rem;
                width: 100%;
            }

            .counters {
                justify-content: center;
                width: 100%;
            }

            .operator-info {
                align-items: center;
            }

            /* Improve form layouts on tablets */
            .grid-2,
            .grid-3 {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .card {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.75rem;
            }

            header {
                padding: 1.25rem;
                margin-bottom: 2rem;
                gap: 1.5rem;
            }

            .logo-main {
                font-size: 1.75rem;
            }

            .logo-subtitle {
                font-size: 0.8rem;
            }

            /* Mobile navigation improvements */
            .nav {
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 2rem;
                justify-content: center;
            }

            .nav-btn {
                padding: 0.875rem 1.25rem;
                font-size: 0.85rem;
                flex: 1;
                min-width: 140px;
                max-width: 180px;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .counters {
                flex-direction: row;
                justify-content: space-around;
                gap: 0.75rem;
                width: 100%;
            }

            .counter {
                padding: 1rem;
                min-width: 100px;
                flex: 1;
            }

            .counter-value {
                font-size: 1.25rem;
            }

            .card {
                padding: 1.25rem;
                margin-bottom: 1rem;
            }

            .card h3 {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
            }

            /* Enhanced table responsiveness */
            .table-responsive {
                border-radius: 0.5rem;
                box-shadow: var(--shadow-sm);
                -webkit-overflow-scrolling: touch;
            }

            .table {
                font-size: 0.8rem;
                min-width: 800px;
                /* Ensure minimum width for scrolling */
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }

            .table th {
                position: sticky;
                top: 0;
                background: var(--tertiary-bg);
                z-index: 10;
                font-size: 0.75rem;
            }

            input,
            select,
            textarea,
            button {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .form-group {
                margin-bottom: 1rem;
            }

            /* Improve attendance form for mobile */
            #attendance .card {
                padding: 1.5rem 1rem;
            }

            #attendance .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.75rem;
            }

            #attendance input,
            #attendance select {
                padding: 1rem 0.875rem;
            }

            #attendance .grid-2 {
                gap: 0.75rem;
            }

            #attendance .grid-2 .form-group {
                margin-bottom: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.75rem 0.5rem;
            }

            header {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .logo-main {
                font-size: 1.5rem;
            }

            .nav-btn {
                padding: 0.625rem 0.875rem;
                font-size: 0.75rem;
                min-width: 100px;
            }

            .counters {
                flex-direction: column;
                gap: 0.5rem;
            }

            .counter {
                padding: 0.875rem 1rem;
                min-width: unset;
            }

            .counter-value {
                font-size: 1.125rem;
            }

            .card {
                padding: 1rem;
            }

            .table th,
            .table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            /* Extra small screen optimizations */
            .dashboard-header h2 {
                font-size: 1.75rem;
            }

            .metric-card {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .metric-icon {
                font-size: 1.75rem;
            }

            .metric-value {
                font-size: 1.75rem;
            }

            /* Modal improvements for small screens */
            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
                max-height: calc(100vh - 2rem);
            }

            .modal-header {
                padding: 1.5rem 1rem;
            }

            .modal-body {
                padding: 1.5rem 1rem;
            }

            /* Form improvements for very small screens */
            .form-group {
                margin-bottom: 0.875rem;
            }

            input,
            select,
            textarea {
                padding: 0.875rem 0.75rem;
            }

            button {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Performance Optimizations */
        * {
            box-sizing: border-box;
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .card,
        .nav-btn,
        .counter {
            will-change: transform;
            transform: translateZ(0);
            /* Hardware acceleration */
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {

            .nav-btn:hover,
            .counter:hover,
            .card:hover,
            .btn-primary:hover,
            .btn-danger:hover {
                transform: none;
            }

            .nav-btn:active,
            .counter:active,
            .btn-primary:active,
            .btn-danger:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }

            .card:active {
                transform: scale(0.99);
            }
        }

        /* Better touch targets */
        .nav-btn,
        .btn-primary,
        .btn-danger,
        .btn-link {
            min-height: 44px;
            min-width: 44px;
        }

        /* Improve form inputs on mobile */
        input,
        select,
        textarea,
        button {
            font-size: 16px;
            /* Prevents zoom on iOS */
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {

            /* Improve scrolling on mobile */
            body {
                -webkit-overflow-scrolling: touch;
            }

            /* Better modal experience on mobile */
            .modal {
                align-items: flex-start;
                padding-top: 2rem;
            }

            .modal-content {
                margin-top: 0;
                border-radius: 1rem 1rem 0 0;
                max-height: calc(100vh - 2rem);
            }

            /* Improve select dropdowns on mobile */
            select {
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1rem;
                padding-right: 2.5rem;
            }

            /* Better focus states for mobile */
            input:focus,
            select:focus,
            textarea:focus {
                outline: 3px solid var(--accent-primary);
                outline-offset: 2px;
            }

            /* Improve button spacing on mobile */
            .grid.grid-3 .btn-primary {
                margin-bottom: 0.5rem;
            }

            /* Better spacing for form elements */
            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .nav,
            .btn,
            header {
                display: none !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }

        /* Footer */
        .footer {
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            background: rgba(10, 10, 15, 0.5);
            backdrop-filter: blur(10px);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .footer-brand {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .footer-logo {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: -0.025em;
        }

        .footer-company {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .footer-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .footer-copyright {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .footer-version {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
            opacity: 0.8;
        }

        /* Keyboard Shortcuts */
        .shortcuts-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            margin-left: 0.5rem;
        }

        .shortcuts-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideIn 0.3s ease-out;
        }

        .shortcuts-modal {
            max-width: 800px;
            width: 100%;
        }

        @keyframes slideIn {
            from {
                transform: scale(0.9) translateY(-20px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--accent-error);
            color: white;
        }

        .modal-body {
            padding: 2rem;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .shortcut-category h4 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-primary);
            padding-bottom: 0.5rem;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .shortcut-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .shortcut-item kbd {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .shortcut-item span {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Dashboard Styles */
        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dashboard-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .dashboard-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .metric-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
        }

        .metric-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }


        /* Chart.js Dark Theme */
        :root {
            --chart-bg: var(--card-bg);
            --chart-text: var(--text-primary);
            --chart-grid: var(--border-color);
        }

        /* Mobile Footer */
        @media (max-width: 768px) {
            .footer {
                margin-top: 2rem;
                padding: 1.5rem 0;
            }

            .footer-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 0 1rem;
            }

            .footer-meta {
                align-items: center;
            }

            .dashboard-header {
                margin-bottom: 2rem;
            }

            .dashboard-header h2 {
                font-size: 2rem;
            }

            .metric-card {
                padding: 1.5rem;
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .metric-icon {
                font-size: 2rem;
            }

            .metric-value {
                font-size: 2rem;
            }

            .grid-4 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading" style="width: 3rem; height: 3rem;"></div>
        <div class="loading-text">Initializing School Attendance System...</div>
    </div>

    <div class="container">
        <header>
            <div class="brand-section">
                <div class="logo-container">
                    <div class="logo-main">School Attendance System</div>
                    <div class="logo-subtitle">by BESTBUY INTERNATIONAL TECHNOLOGY</div>
                </div>
                <div class="brand-tagline">
                    <span class="tagline-text">Smart ‚Ä¢ Secure ‚Ä¢ Efficient</span>
                </div>
            </div>
            <div class="user-info">
                <div class="counters">
                    <div class="counter">
                        <div class="counter-label">Today's Attendance</div>
                        <div class="counter-value" id="today-count">0</div>
                    </div>
                    <div class="counter">
                        <div class="counter-label">My Records</div>
                        <div class="counter-value" id="my-count">0</div>
                    </div>
                </div>
                <div class="operator-info">
                    <div class="operator-name">Not logged in</div>
                    <div class="operator-status">‚óè Offline</div>
                    <button id="shortcuts-btn" class="shortcuts-btn" title="Keyboard Shortcuts (F1)">‚å®Ô∏è</button>
                </div>
            </div>
        </header>


        <!-- Login Section -->
        <section id="login" class="section active">
            <div class="card">
                <h3>Login to School Attendance System</h3>
                <form id="login-form">
                    <div class="form-group">
                        <label for="email-input">Email</label>
                        <input type="email" id="email-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="password-input">Password</label>
                        <input type="password" id="password-input" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary" id="login-btn">Login</button>
                </form>
                <div id="login-status" class="hidden"></div>
                <div class="text-center" style="margin-top: 1rem;">
                    <p>Don't have an account? <button id="show-signup" class="btn-link">Sign Up</button></p>
                </div>
            </div>
        </section>

        <!-- Signup Section -->
        <section id="signup" class="section">
            <div class="card">
                <h3>Create Account</h3>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-name">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <input type="text" id="signup-username" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password" required>
                    </div>
                    <button type="submit" class="btn-primary" id="signup-btn">Sign Up</button>
                </form>
                <div id="signup-status" class="hidden"></div>
                <div class="text-center" style="margin-top: 1rem;">
                    <p>Already have an account? <button id="show-login" class="btn-link">Login</button></p>
                </div>
            </div>
        </section>

        <nav class="nav" id="main-nav" style="display: none;">
            <button class="nav-btn active" data-section="dashboard">Dashboard</button>
            <button class="nav-btn" data-section="attendance">Attendance</button>
            <button class="nav-btn" data-section="import">Import Students</button>
            <button class="nav-btn hidden" data-section="admin">Admin</button>
            <button class="nav-btn" data-section="reports">Reports</button>
            <button class="nav-btn" id="logout-btn">Logout</button>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="dashboard-header">
                <h2>Attendance Analytics Dashboard</h2>
                <p class="dashboard-subtitle">Real-time insights and performance metrics</p>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-4">
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-content">
                        <div class="metric-value" id="total-students">0</div>
                        <div class="metric-label">Total Students</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚úÖ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="today-attendance">0</div>
                        <div class="metric-label">Today's Attendance</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-content">
                        <div class="metric-value" id="attendance-rate">0%</div>
                        <div class="metric-label">Attendance Rate</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üèÜ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="top-performer">N/A</div>
                        <div class="metric-label">Top Performer</div>
                    </div>
                </div>
            </div>


        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="section active">
            <div class="card">
                <h3>Mark Attendance</h3>
                <form id="attendance-form">
                    <div class="form-group">
                        <label for="matric-input">Matric Number</label>
                        <input type="text" id="matric-input" placeholder="Enter matric number" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="student-name">Student Name</label>
                        <input type="text" id="student-name" readonly>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button type="button" id="add-student-btn" class="btn-primary" style="display: none;">Add
                                New Student</button>
                            <button type="button" id="edit-student-btn" class="btn-primary" style="display: none;">Edit
                                Student</button>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Faculty</label>
                            <input type="text" id="student-faculty" readonly>
                        </div>
                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" id="student-department" readonly>
                        </div>
                        <div class="form-group">
                            <label>Grade</label>
                            <input type="text" id="student-grade" readonly>
                        </div>
                        <div class="form-group">
                            <label>Source</label>
                            <input type="text" id="student-source" readonly>
                        </div>
                        <div class="form-group">
                            <label>Next of Kin</label>
                            <input type="text" id="student-next-of-kin" readonly>
                        </div>
                        <div class="form-group">
                            <label for="phone-input">Phone Number *</label>
                            <input type="tel" id="phone-input" placeholder="Phone number (required)" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes-input">Notes (optional)</label>
                        <textarea id="notes-input" placeholder="Additional notes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn-primary" id="mark-btn">Mark Attendance</button>
                </form>
                <div id="attendance-status" class="hidden"></div>
            </div>
        </section>

        <!-- Import Section -->
        <section id="import" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Import Student Master File</h3>
                    <form id="import-form">
                        <div class="form-group">
                            <label for="school-name-input">School Name *</label>
                            <input type="text" id="school-name-input"
                                placeholder="Enter school name (e.g., University of Lagos)" required>
                        </div>
                        <div class="form-group">
                            <label for="file-input">Select CSV or XLSX file</label>
                            <input type="file" id="file-input" accept=".csv,.xlsx,.xls" required>
                        </div>
                        <button type="submit" class="btn-primary">Import Students</button>
                    </form>
                    <div id="import-status"></div>
                    <div id="import-progress" class="hidden">
                        <progress value="0" max="100"></progress>
                        <span id="progress-text">0%</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Import/Update Student Records</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">For attendance
                        tracking, only records with phone numbers will be processed. Use this for importing attendance
                        data or updating student information with phone numbers.</p>
                    <form id="attendance-import-form">
                        <div class="form-group">
                            <label for="attendance-file-input">Select CSV or XLSX file</label>
                            <input type="file" id="attendance-file-input" accept=".csv,.xlsx,.xls" required>
                        </div>
                        <div class="form-group">
                            <label for="attendance-date-input">Attendance Date (optional - for attendance
                                records)</label>
                            <input type="date" id="attendance-date-input">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="update-student-info" checked>
                                Update student information (faculty, department, etc.)
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="import-attendance-records" checked>
                                Import attendance records
                            </label>
                        </div>
                        <button type="submit" class="btn-primary">Import/Update Records</button>
                    </form>
                    <div id="attendance-import-status"></div>
                    <div id="attendance-import-progress" class="hidden">
                        <progress value="0" max="100"></progress>
                        <span id="attendance-progress-text">0%</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Manage Operators</h3>
                    <button id="add-operator-btn" class="btn-primary">Add Operator</button>
                    <div id="operators-list"></div>
                </div>
                <div class="card">
                    <h3>System Settings</h3>
                    <button id="reimport-btn" class="btn-primary">Re-run Last Import</button>
                    <button id="clear-data-btn" class="btn-danger">Clear All Data</button>
                    <button id="rotate-keys-btn" class="btn-danger">Rotate API Keys</button>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
            <div class="card">
                <h3>Attendance Reports</h3>
                <div class="form-group">
                    <label for="report-date">Select Date</label>
                    <input type="date" id="report-date" value="">
                </div>
                <div class="grid grid-3">
                    <button id="export-daily-csv-btn" class="btn-primary">Export Today's CSV</button>
                    <button id="export-daily-xlsx-btn" class="btn-primary">Export Today's XLSX</button>
                    <button id="advanced-export-btn" class="btn-primary">Advanced Export</button>
                </div>
                <div class="grid grid-2" style="margin-top: 1rem;">
                    <button id="view-report-btn" class="btn-primary">View Report</button>
                    <button id="export-templates-btn" class="btn-primary">Export Templates</button>
                </div>
                <div class="grid grid-2" style="margin-top: 1rem;">
                    <button id="clear-data-reports-btn" class="btn-danger">Clear All Data</button>
                    <div style="font-size: 0.8rem; color: #666;">‚ö†Ô∏è This will delete all students and attendance records
                    </div>
                </div>
                <div id="report-table-container" class="hidden">
                    <div class="table-responsive">
                        <table class="table" id="report-table">
                            <thead>
                                <tr>
                                    <th>Matric Number</th>
                                    <th>Student Name</th>
                                    <th>Faculty</th>
                                    <th>Department</th>
                                    <th>Grade</th>
                                    <th>Phone Number</th>
                                    <th>Attendance Time</th>
                                    <th>Operator</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="report-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Export Modal -->
        <div id="advanced-export-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Advanced Export</h3>
                    <button class="modal-close" id="advanced-export-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="advanced-export-form">
                        <!-- Date Range -->
                        <div class="form-group">
                            <label for="export-start-date">Start Date</label>
                            <input type="date" id="export-start-date" required>
                        </div>
                        <div class="form-group">
                            <label for="export-end-date">End Date</label>
                            <input type="date" id="export-end-date" required>
                        </div>

                        <!-- Filters -->
                        <div class="card" style="margin: 1rem 0; padding: 1rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--accent-primary);">Filters (Optional)</h4>
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="export-faculty">Faculty</label>
                                    <select id="export-faculty">
                                        <option value="">All Faculties</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="export-department">Department</label>
                                    <select id="export-department">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="export-grade">Grade</label>
                                    <select id="export-grade">
                                        <option value="">All Grades</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="export-operator">Operator</label>
                                    <select id="export-operator">
                                        <option value="">All Operators</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="card" style="margin: 1rem 0; padding: 1rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--accent-primary);">Export Options</h4>
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="export-format">Format</label>
                                    <select id="export-format" required>
                                        <option value="csv">CSV (Comma Separated)</option>
                                        <option value="xlsx">Excel (XLSX)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="export-group-by">Group By</label>
                                    <select id="export-group-by">
                                        <option value="none">No Grouping</option>
                                        <option value="faculty">Faculty</option>
                                        <option value="department">Department</option>
                                        <option value="grade">Grade</option>
                                        <option value="operator">Operator</option>
                                        <option value="date">Date</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="export-include-summary" checked>
                                    Include Summary Sheet
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="export-anonymous">
                                    Anonymous Export (Remove Personal Info)
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">Generate Export</button>
                    </form>
                    <div id="advanced-export-status" class="hidden"></div>
                    <div id="export-progress" class="hidden">
                        <progress value="0" max="100" style="width: 100%; margin: 1rem 0;"></progress>
                        <span id="export-progress-text">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Templates Modal -->
        <div id="export-templates-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Export Templates</h3>
                    <button class="modal-close" id="export-templates-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Choose a pre-configured export
                        template:</p>
                    <div class="grid grid-2">
                        <button class="btn-primary template-btn" data-template="daily-report">üìä Daily Report</button>
                        <button class="btn-primary template-btn" data-template="weekly-summary">üìà Weekly
                            Summary</button>
                        <button class="btn-primary template-btn" data-template="faculty-report">üèõÔ∏è Faculty
                            Report</button>
                        <button class="btn-primary template-btn" data-template="operator-performance">üë§ Operator
                            Performance</button>
                        <button class="btn-primary template-btn" data-template="absentee-list">‚ùå Absentee List</button>
                        <button class="btn-primary template-btn" data-template="late-arrivals">‚è∞ Late Arrivals</button>
                    </div>
                    <div id="templates-status" class="hidden" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Add Student Modal -->
        <div id="add-student-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Add New Student</h3>
                    <button class="modal-close" id="add-student-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="add-student-form">
                        <div class="form-group">
                            <label for="new-matric">Matric Number *</label>
                            <input type="text" id="new-matric" required>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="new-last-name">Last Name *</label>
                                <input type="text" id="new-last-name" required>
                            </div>
                            <div class="form-group">
                                <label for="new-other-names">Other Names *</label>
                                <input type="text" id="new-other-names" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="new-phone">Phone Number *</label>
                            <input type="tel" id="new-phone" required>
                        </div>
                        <button type="submit" class="btn-primary">Add Student</button>
                    </form>
                    <div id="add-student-status" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div id="edit-student-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Student</h3>
                    <button class="modal-close" id="edit-student-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-student-form">
                        <div class="form-group">
                            <label for="edit-matric">Matric Number</label>
                            <input type="text" id="edit-matric" readonly>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="edit-last-name">Last Name *</label>
                                <input type="text" id="edit-last-name" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-other-names">Other Names *</label>
                                <input type="text" id="edit-other-names" required>
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="edit-faculty">Faculty</label>
                                <input type="text" id="edit-faculty">
                            </div>
                            <div class="form-group">
                                <label for="edit-department">Department</label>
                                <input type="text" id="edit-department">
                            </div>
                        </div>
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label for="edit-grade">Grade</label>
                                <input type="text" id="edit-grade">
                            </div>
                            <div class="form-group">
                                <label for="edit-source">Source</label>
                                <input type="text" id="edit-source">
                            </div>
                            <div class="form-group">
                                <label for="edit-phone">Phone *</label>
                                <input type="tel" id="edit-phone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-next-of-kin">Next of Kin</label>
                            <input type="text" id="edit-next-of-kin">
                        </div>
                        <button type="submit" class="btn-primary">Update Student</button>
                    </form>
                    <div id="edit-student-status" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- Complete Student Info Modal (for attendance marking) -->
        <div id="complete-student-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Complete Student Information</h3>
                    <button class="modal-close" id="complete-student-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Please fill in the missing information
                        for <strong id="complete-student-name"></strong> before marking attendance:</p>
                    <form id="complete-student-form">
                        <input type="hidden" id="complete-matric">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="complete-faculty">Faculty</label>
                                <input type="text" id="complete-faculty" required>
                            </div>
                            <div class="form-group">
                                <label for="complete-department">Department</label>
                                <input type="text" id="complete-department" required>
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="complete-grade">Grade</label>
                                <input type="text" id="complete-grade" required>
                            </div>
                            <div class="form-group">
                                <label for="complete-source">Source</label>
                                <input type="text" id="complete-source" required>
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="complete-next-of-kin">Next of Kin</label>
                                <input type="text" id="complete-next-of-kin" required>
                            </div>
                            <div class="form-group">
                                <label for="complete-phone">Phone *</label>
                                <input type="tel" id="complete-phone" required>
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <button type="button" id="skip-complete-btn" class="btn-danger">Skip & Mark
                                Attendance</button>
                            <button type="submit" class="btn-primary">Complete & Mark Attendance</button>
                        </div>
                    </form>
                    <div id="complete-student-status" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- Keyboard Shortcuts Modal -->
        <div id="shortcuts-modal" class="modal hidden">
            <div class="modal-content shortcuts-modal">
                <div class="modal-header">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <button class="modal-close" id="shortcuts-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="shortcuts-grid">
                        <div class="shortcut-category">
                            <h4>üì± Navigation</h4>
                            <div class="shortcut-item">
                                <kbd>1</kbd> or <kbd>D</kbd> <span>Dashboard</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>2</kbd> or <kbd>A</kbd> <span>Attendance</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>3</kbd> or <kbd>I</kbd> <span>Import Students</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>4</kbd> or <kbd>R</kbd> <span>Reports</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>5</kbd> or <kbd>Ctrl+A</kbd> <span>Admin</span>
                            </div>
                        </div>

                        <div class="shortcut-category">
                            <h4>üìù Attendance Form</h4>
                            <div class="shortcut-item">
                                <kbd>Alt+M</kbd> <span>Focus Matric Input</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Alt+P</kbd> <span>Focus Phone Input</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Enter</kbd> <span>Submit Attendance</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl+Enter</kbd> <span>Quick Submit</span>
                            </div>
                        </div>

                        <div class="shortcut-category">
                            <h4>üìä Actions</h4>
                            <div class="shortcut-item">
                                <kbd>Ctrl+E</kbd> <span>Export Today's CSV</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl+X</kbd> <span>Export Today's XLSX</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl+R</kbd> <span>Refresh Dashboard</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl+L</kbd> <span>Clear Form</span>
                            </div>
                        </div>

                        <div class="shortcut-category">
                            <h4>üîß General</h4>
                            <div class="shortcut-item">
                                <kbd>F1</kbd> <span>Show Shortcuts</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Esc</kbd> <span>Close Modals</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl+/</kbd> <span>Help</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">School Attendance System</div>
                    <div class="footer-company">by BESTBUY INTERNATIONAL TECHNOLOGY</div>
                </div>
                <div class="footer-meta">
                    <div class="footer-copyright">¬© 2025 All Rights Reserved</div>
                    <div class="footer-version">v2.0.0</div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Supabase client setup
        const SUPABASE_URL = 'https://sjrhljtjgxjohkipxaky.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqcmhsanRqZ3hqb2hraXB4YWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwOTMzNDQsImV4cCI6MjA3OTY2OTM0NH0.n57XovSTvg6WAAGagGScMs7OjLi7zc_GqrwALWa0fVQ';
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentOperator = null;
        let currentSchool = { id: '550e8400-e29b-41d4-a716-446655440001', name: 'University of Lagos' };
        let realtimeSubscription = null;

        // DOM elements
        const matricInput = document.getElementById('matric-input');
        const studentNameInput = document.getElementById('student-name');
        const phoneInput = document.getElementById('phone-input');
        const notesInput = document.getElementById('notes-input');
        const markBtn = document.getElementById('mark-btn');
        const attendanceStatus = document.getElementById('attendance-status');
        const todayCountEl = document.getElementById('today-count');
        const myCountEl = document.getElementById('my-count');
        const logoutBtn = document.getElementById('logout-btn');
        const navBtns = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.section');

        // Add student elements
        const addStudentBtn = document.getElementById('add-student-btn');
        const addStudentModal = document.getElementById('add-student-modal');
        const addStudentForm = document.getElementById('add-student-form');
        const addStudentClose = document.getElementById('add-student-close');
        const addStudentStatus = document.getElementById('add-student-status');

        // Edit student elements
        const editStudentBtn = document.getElementById('edit-student-btn');
        const editStudentModal = document.getElementById('edit-student-modal');
        const editStudentForm = document.getElementById('edit-student-form');
        const editStudentClose = document.getElementById('edit-student-close');
        const editStudentStatus = document.getElementById('edit-student-status');

        // Complete student elements
        const completeStudentModal = document.getElementById('complete-student-modal');
        const completeStudentForm = document.getElementById('complete-student-form');
        const completeStudentClose = document.getElementById('complete-student-close');
        const completeStudentStatus = document.getElementById('complete-student-status');
        const skipCompleteBtn = document.getElementById('skip-complete-btn');

        // Advanced export elements
        const advancedExportBtn = document.getElementById('advanced-export-btn');
        const exportTemplatesBtn = document.getElementById('export-templates-btn');
        const advancedExportModal = document.getElementById('advanced-export-modal');
        const exportTemplatesModal = document.getElementById('export-templates-modal');
        const advancedExportForm = document.getElementById('advanced-export-form');
        const advancedExportClose = document.getElementById('advanced-export-close');
        const exportTemplatesClose = document.getElementById('export-templates-close');
        const advancedExportStatus = document.getElementById('advanced-export-status');
        const exportProgress = document.getElementById('export-progress');
        const exportProgressText = document.getElementById('export-progress-text');
        const templateBtns = document.querySelectorAll('.template-btn');

        // Login elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const signupNameInput = document.getElementById('signup-name');
        const signupUsernameInput = document.getElementById('signup-username');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const loginStatus = document.getElementById('login-status');
        const signupStatus = document.getElementById('signup-status');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const mainNav = document.getElementById('main-nav');

        // Initialize app
        async function init() {
            console.log('Initializing app...');

            // Load saved school name
            const savedSchoolName = localStorage.getItem('schoolName');
            if (savedSchoolName) {
                updateHeaderSchoolName(savedSchoolName);
            }

            // Check auth state
            const { data: { session }, error } = await supabase.auth.getSession();
            console.log('Auth session:', session);

            if (session?.user) {
                console.log('User authenticated, handling user:', session.user);
                await handleAuthenticatedUser(session.user);
            } else {
                console.log('No authenticated user, showing login');
                showAuthSection('login');
                document.getElementById('loading-overlay').classList.add('hidden');
            }

            // Event listeners
            setupEventListeners();
        }

        async function handleAuthenticatedUser(user) {
            console.log('Handling authenticated user:', user.email, user.user_metadata);

            // Get or create operator record
            const { data: operator, error } = await supabase
                .from('operators')
                .select('*')
                .eq('auth_uid', user.id)
                .single();

            console.log('Operator lookup result:', operator, error);

            if (operator) {
                currentOperator = operator;
                console.log('Using existing operator:', currentOperator);
            } else {
                // Create new operator
                const operatorName = user.user_metadata?.full_name || user.email.split('@')[0];
                const operatorUsername = user.user_metadata?.username || user.email.split('@')[0];

                console.log('Creating new operator with name:', operatorName, 'username:', operatorUsername);

                const { data: newOperator, error: createError } = await supabase
                    .from('operators')
                    .insert({
                        auth_uid: user.id,
                        name: operatorName,
                        username: operatorUsername,
                        school_id: '550e8400-e29b-41d4-a716-446655440001', // Default school
                        is_admin: false
                    })
                    .select()
                    .single();

                if (createError) {
                    console.error('Error creating operator:', createError);
                    showAuthStatus('Error setting up account. Please contact admin.', 'error', 'login');
                    return;
                }
                currentOperator = newOperator;
                console.log('Created new operator:', currentOperator);
            }

            currentSchool = {
                id: '550e8400-e29b-41d4-a716-446655440001',
                name: 'University of Lagos'
            };

            // Update header with user info
            const displayName = currentOperator.username
                ? `${currentOperator.name} (${currentOperator.username})`
                : currentOperator.name;

            console.log('Updating header with:', displayName);
            document.querySelector('.operator-name').textContent = displayName;
            document.querySelector('.operator-status').textContent = currentOperator.is_admin ? '‚óè Admin' : '‚óè Operator';

            // Show admin section if user is admin
            if (currentOperator.is_admin) {
                document.querySelector('[data-section="admin"]').classList.remove('hidden');
            }

            // Show main app
            showMainApp();

            // Load initial dashboard data
            await loadDashboardData();

            // Hide loading overlay
            document.getElementById('loading-overlay').classList.add('hidden');

            // Set default report date to today
            document.getElementById('report-date').valueAsDate = new Date();

            // Set default attendance import date to today
            document.getElementById('attendance-date-input').valueAsDate = new Date();

            startRealtime();
            updateCounters();
        }

        function showAuthSection(section) {
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            mainNav.style.display = 'none';
        }

        function showMainApp() {
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            mainNav.style.display = 'flex';
        }

        function setupEventListeners() {
            // Navigation
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const sectionId = btn.dataset.section;
                    showSection(sectionId);
                });
            });

            // Attendance form
            document.getElementById('attendance-form').addEventListener('submit', handleAttendanceSubmit);
            matricInput.addEventListener('input', handleMatricInput);
            phoneInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    markBtn.click();
                }
            });

            // Import
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
            document.getElementById('import-form').addEventListener('submit', handleImportSubmit);
            document.getElementById('attendance-import-form').addEventListener('submit', handleAttendanceImportSubmit);

            // Reports
            document.getElementById('export-daily-csv-btn').addEventListener('click', () => exportDailyReport('csv'));
            document.getElementById('export-daily-xlsx-btn').addEventListener('click', () => exportDailyReport('xlsx'));
            document.getElementById('view-report-btn').addEventListener('click', viewReport);
            document.getElementById('clear-data-reports-btn').addEventListener('click', clearAllData);

            // Admin
            document.getElementById('clear-data-btn').addEventListener('click', clearAllData);

            // Auth forms
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            showSignupBtn.addEventListener('click', () => showAuthSection('signup'));
            showLoginBtn.addEventListener('click', () => showAuthSection('login'));
            logoutBtn.addEventListener('click', handleLogout);

            // Auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state change:', event, session?.user?.email);
                if (event === 'SIGNED_IN' && session?.user) {
                    console.log('User signed in, handling authenticated user');
                    await handleAuthenticatedUser(session.user);
                } else if (event === 'SIGNED_OUT') {
                    console.log('User signed out, showing login');
                    showAuthSection('login');
                }
            });

            // Add student modal
            addStudentBtn.addEventListener('click', showAddStudentModal);
            addStudentClose.addEventListener('click', hideAddStudentModal);
            addStudentForm.addEventListener('submit', handleAddStudent);

            // Edit student modal
            editStudentBtn.addEventListener('click', showEditStudentModal);
            editStudentClose.addEventListener('click', hideEditStudentModal);
            editStudentForm.addEventListener('submit', handleEditStudent);

            // Complete student modal
            completeStudentClose.addEventListener('click', hideCompleteStudentModal);
            completeStudentForm.addEventListener('submit', handleCompleteStudentAndMarkAttendance);
            skipCompleteBtn.addEventListener('click', handleSkipCompleteAndMarkAttendance);

            // Advanced export modal
            advancedExportBtn.addEventListener('click', showAdvancedExportModal);
            exportTemplatesBtn.addEventListener('click', showExportTemplatesModal);
            advancedExportClose.addEventListener('click', hideAdvancedExportModal);
            exportTemplatesClose.addEventListener('click', hideExportTemplatesModal);
            advancedExportForm.addEventListener('submit', handleAdvancedExport);

            // Template buttons
            templateBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const template = e.target.dataset.template;
                    exportTemplate(template);
                });
            });

            // Close modal when clicking outside
            addStudentModal.addEventListener('click', (e) => {
                if (e.target.id === 'add-student-modal') {
                    hideAddStudentModal();
                }
            });

            editStudentModal.addEventListener('click', (e) => {
                if (e.target.id === 'edit-student-modal') {
                    hideEditStudentModal();
                }
            });

            completeStudentModal.addEventListener('click', (e) => {
                if (e.target.id === 'complete-student-modal') {
                    hideCompleteStudentModal();
                }
            });

            advancedExportModal.addEventListener('click', (e) => {
                if (e.target.id === 'advanced-export-modal') {
                    hideAdvancedExportModal();
                }
            });

            exportTemplatesModal.addEventListener('click', (e) => {
                if (e.target.id === 'export-templates-modal') {
                    hideExportTemplatesModal();
                }
            });

            // Keyboard shortcuts
            document.getElementById('shortcuts-btn').addEventListener('click', showShortcutsModal);
            document.getElementById('shortcuts-close').addEventListener('click', hideShortcutsModal);

            // Close modal when clicking outside
            document.getElementById('shortcuts-modal').addEventListener('click', (e) => {
                if (e.target.id === 'shortcuts-modal') {
                    hideShortcutsModal();
                }
            });

            // Global keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Navigation
        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Load dashboard data when dashboard is shown
            if (sectionId === 'dashboard') {
                loadDashboardData();
            }
        }

        // Attendance functions
        async function handleMatricInput() {
            const matric = matricInput.value.trim();
            if (matric.length < 3 || !currentSchool) return;

            const { data: student, error } = await supabase
                .from('students')
                .select('*')
                .eq('school_id', currentSchool.id)
                .eq('matric_number', matric)
                .single();

            if (student) {
                studentNameInput.value = student.name;
                document.getElementById('student-faculty').value = student.faculty || '';
                document.getElementById('student-department').value = student.department || '';
                document.getElementById('student-grade').value = student.grade || '';
                document.getElementById('student-source').value = student.source || '';
                document.getElementById('student-next-of-kin').value = student.next_of_kin || '';
                phoneInput.value = student.phone || '';

                // Check if already marked today
                const today = new Date().toISOString().split('T')[0];
                const { data: existingAttendance, error: attendanceError } = await supabase
                    .from('attendance')
                    .select('ts')
                    .eq('school_id', currentSchool.id)
                    .eq('matric_number', matric)
                    .eq('attendance_date', today)
                    .maybeSingle();


                if (existingAttendance && !attendanceError) {
                    const attendanceTime = new Date(existingAttendance.ts);
                    const timeString = attendanceTime.toLocaleString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    // Show warning that student already marked
                    document.getElementById('attendance-status').innerHTML = `
                        <div class="status error">
                            ‚ö†Ô∏è <strong>${student.name}</strong> already marked attendance today at ${timeString}
                        </div>
                    `;
                    document.getElementById('attendance-status').classList.remove('hidden');

                    // Disable mark button
                    markBtn.disabled = true;
                    markBtn.textContent = 'Already Marked Today';
                } else {
                    // Clear any previous status
                    document.getElementById('attendance-status').classList.add('hidden');
                    markBtn.disabled = false;
                    markBtn.textContent = 'Mark Attendance';
                    phoneInput.focus();
                }

                // Hide add student button since student exists
                addStudentBtn.style.display = 'none';

                // Show edit student button for all operators
                if (currentOperator) {
                    editStudentBtn.style.display = 'inline-block';
                    editStudentBtn.dataset.matric = matric;
                } else {
                    editStudentBtn.style.display = 'none';
                }
            } else {
                studentNameInput.value = '';
                document.getElementById('student-faculty').value = '';
                document.getElementById('student-department').value = '';
                document.getElementById('student-grade').value = '';
                document.getElementById('student-source').value = '';
                document.getElementById('student-next-of-kin').value = '';
                phoneInput.value = '';

                // Show add student button
                addStudentBtn.style.display = 'inline-block';
                document.getElementById('new-matric').value = matric;

                // Hide edit student button
                editStudentBtn.style.display = 'none';

                // Clear status
                document.getElementById('attendance-status').classList.add('hidden');
                markBtn.disabled = true;
                markBtn.textContent = 'Student Not Found';
            }
        }

        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            const matric = matricInput.value.trim();
            const phone = phoneInput.value.trim();
            const notes = notesInput.value.trim();

            if (!matric || !currentSchool) return;

            // Validate that phone number is provided
            if (!phone) {
                showStatus('‚ùå Phone number is required to mark attendance.', 'error');
                phoneInput.focus();
                return;
            }

            // Double-check if already marked today before submitting
            const today = new Date().toISOString().split('T')[0];
            const { data: existingAttendance } = await supabase
                .from('attendance')
                .select('id')
                .eq('school_id', currentSchool.id)
                .eq('matric_number', matric)
                .eq('attendance_date', today)
                .maybeSingle();

            if (existingAttendance) {
                showStatus('‚ö†Ô∏è This student has already been marked for attendance today!', 'error');
                return;
            }

            // Student information is now optional - proceed with attendance marking

            // Student has complete info, mark attendance directly
            await markAttendance(matric, phone, notes);
        }

        function resetAttendanceForm() {
            matricInput.value = '';
            studentNameInput.value = '';
            document.getElementById('student-faculty').value = '';
            document.getElementById('student-department').value = '';
            document.getElementById('student-grade').value = '';
            document.getElementById('student-source').value = '';
            document.getElementById('student-next-of-kin').value = '';
            phoneInput.value = '';
            notesInput.value = '';
            addStudentBtn.style.display = 'none';
            editStudentBtn.style.display = 'none';
            matricInput.focus();
        }

        function showStatus(message, type) {
            attendanceStatus.textContent = message;
            attendanceStatus.className = `status ${type}`;
            attendanceStatus.classList.remove('hidden');
            setTimeout(() => attendanceStatus.classList.add('hidden'), 3000);
        }

        // Realtime
        function startRealtime() {
            realtimeSubscription = supabase
                .channel('attendance_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => {
                    updateCounters();
                })
                .subscribe();
        }

        function stopRealtime() {
            if (realtimeSubscription) {
                supabase.removeChannel(realtimeSubscription);
                realtimeSubscription = null;
            }
        }

        async function updateCounters() {
            if (!currentSchool) {
                todayCountEl.textContent = '0';
                myCountEl.textContent = '0';
                return;
            }

            // Today count for school
            const { data: todayData, error: todayError } = await supabase
                .from('attendance')
                .select('id', { count: 'exact' })
                .eq('school_id', currentSchool.id)
                .eq('attendance_date', new Date().toISOString().split('T')[0]);

            if (!todayError) {
                todayCountEl.textContent = todayData.length;
            }

            // My count for school
            if (currentOperator) {
                const { data: myData, error: myError } = await supabase
                    .from('attendance')
                    .select('id', { count: 'exact' })
                    .eq('school_id', currentSchool.id)
                    .eq('attendance_date', new Date().toISOString().split('T')[0])
                    .eq('operator_id', currentOperator.id);

                if (!myError) {
                    myCountEl.textContent = myData.length;
                }
            }
        }

        // Import functions
        let currentHeaders = [];

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Parse file to get headers
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                let headers;
                if (file.name.endsWith('.csv')) {
                    // Parse CSV manually
                    const lines = data.split('\n').filter(line => line.trim());
                    const firstLine = lines[0];
                    headers = firstLine.split(',').map(cell => cell.replace(/^"|"$/g, '').trim());
                } else {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    headers = jsonData[0];
                }
                currentHeaders = headers;
            };
            reader.readAsBinaryString(file);
        }


        async function handleImportSubmit(e) {
            e.preventDefault();
            const file = document.getElementById('file-input').files[0];
            const schoolName = document.getElementById('school-name-input').value.trim();

            if (!schoolName) {
                document.getElementById('import-status').innerHTML = '<div class="status error">Please enter a school name.</div>';
                return;
            }

            if (!file) return;

            // Save school name to localStorage
            localStorage.setItem('schoolName', schoolName);
            updateHeaderSchoolName(schoolName);

            // Parse file again for import
            let data;
            if (file.name.endsWith('.csv')) {
                const text = await file.text();
                // Parse CSV manually
                const lines = text.split('\n').filter(line => line.trim());
                data = lines.map(line => line.split(',').map(cell => cell.replace(/^"|"$/g, '').trim()));
            } else {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, blankrows: false });
            }

            console.log('Parsed data length:', data.length);

            // Auto-detect columns from first row
            const headers = data[0];
            const findColumn = (names) => {
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i]?.toString().toLowerCase().trim();
                    if (header && names.some(name => header.includes(name.toLowerCase()))) {
                        return i;
                    }
                }
                return -1;
            };

            const matricCol = findColumn(['matric', 'number', 'id']);
            const lastNameCol = findColumn(['last', 'surname']);
            const otherNamesCol = findColumn(['other', 'first', 'given']);
            const facultyCol = findColumn(['faculty']);
            const departmentCol = findColumn(['department']);
            const gradeCol = findColumn(['grade', 'level', 'class']);
            const sourceCol = findColumn(['source']);
            const nextOfKinCol = findColumn(['next', 'kin', 'guardian']);
            const phoneCol = findColumn(['phone', 'mobile', 'contact']);

            if (matricCol === -1 || lastNameCol === -1 || otherNamesCol === -1) {
                alert('Could not auto-detect required columns. CSV must include at least: matric, last name, other names. All other fields are optional and can be filled later when marking attendance.');
                return;
            }

            const progressEl = document.getElementById('import-progress');
            const progressText = document.getElementById('progress-text');
            progressEl.classList.remove('hidden');

            try {
                let data;
                if (file.name.endsWith('.csv')) {
                    const text = await file.text();
                    data = XLSX.utils.csv_to_sheet(text);
                    data = XLSX.utils.sheet_to_json(data, { header: 1, defval: null });
                } else {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, blankrows: false });
                }

                // Remove header
                data.shift();
                console.log('Total data rows after header removal:', data.length);

                // Batch upsert
                const batchSize = 500;
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                console.log('Starting batch processing...');

                for (let i = 0; i < data.length; i += batchSize) {
                    const batch = data.slice(i, i + batchSize);
                    console.log(`Processing batch ${Math.floor(i / batchSize) + 1}, rows ${i} to ${i + batch.length - 1}`);
                    const students = batch.map(row => ({
                        school_id: currentSchool.id,
                        matric_number: row[matricCol]?.toString().trim(),
                        last_name: row[lastNameCol]?.toString().trim(),
                        other_names: row[otherNamesCol]?.toString().trim(),
                        faculty: facultyCol !== -1 ? row[facultyCol]?.toString().trim() : null,
                        department: departmentCol !== -1 ? row[departmentCol]?.toString().trim() : null,
                        grade: gradeCol !== -1 ? row[gradeCol]?.toString().trim() : null,
                        source: sourceCol !== -1 ? row[sourceCol]?.toString().trim() : null,
                        next_of_kin: nextOfKinCol !== -1 ? row[nextOfKinCol]?.toString().trim() : null,
                        phone: phoneCol !== -1 ? row[phoneCol]?.toString().trim() : null
                    })).filter(s => s.matric_number && s.last_name && s.other_names);

                    console.log(`Batch ${Math.floor(i / batchSize) + 1}: ${students.length} valid students`);

                    if (students.length > 0) {
                        const { error } = await supabase
                            .from('students')
                            .upsert(students, { onConflict: 'school_id,matric_number' });

                        if (error) {
                            console.error(`Batch ${Math.floor(i / batchSize) + 1} error:`, error);
                            errorCount += students.length;
                            errors.push(`Batch ${Math.floor(i / batchSize) + 1}: ${error.message}`);
                        } else {
                            successCount += students.length;
                            console.log(`Batch ${Math.floor(i / batchSize) + 1} success: ${students.length} students`);
                        }
                    }

                    console.log(`Batch ${Math.floor(i / batchSize) + 1}: ${students.length} valid students`);

                    if (students.length > 0) {
                        const { error } = await supabase
                            .from('students')
                            .upsert(students, { onConflict: 'school_id,matric_number' });

                        if (error) {
                            console.error(`Batch ${Math.floor(i / batchSize) + 1} error:`, error);
                            errorCount += students.length;
                            errors.push(`Batch ${Math.floor(i / batchSize) + 1}: ${error.message}`);
                        } else {
                            successCount += students.length;
                            console.log(`Batch ${Math.floor(i / batchSize) + 1} success: ${students.length} students`);
                        }
                    }

                    // Update progress
                    const progress = Math.round((i + batch.length) / data.length * 100);
                    progressEl.querySelector('progress').value = progress;
                    progressText.textContent = `${progress}%`;
                }

                let statusMessage = `Import completed. ${successCount} students imported successfully.`;
                if (errorCount > 0) {
                    statusMessage += ` ${errorCount} errors.`;
                }
                document.getElementById('import-status').innerHTML = `<div class="status ${errorCount > 0 ? 'error' : 'success'}">${statusMessage}</div>`;
                if (errors.length > 0) {
                    document.getElementById('import-status').innerHTML += '<ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                }

            } catch (error) {
                console.error('Import error:', error);
                document.getElementById('import-status').innerHTML = `<div class="status error">Import failed: ${error.message}</div>`;
            } finally {
                progressEl.classList.add('hidden');
            }
        }

        async function handleAttendanceImportSubmit(e) {
            e.preventDefault();
            const file = document.getElementById('attendance-file-input').files[0];
            const attendanceDate = document.getElementById('attendance-date-input').value;
            const updateStudentInfo = document.getElementById('update-student-info').checked;
            const importAttendance = document.getElementById('import-attendance-records').checked;

            if (!file) return;
            if (importAttendance && !attendanceDate) {
                alert('Please select an attendance date for importing attendance records.');
                return;
            }
            if (!updateStudentInfo && !importAttendance) {
                alert('Please select at least one option: update student info or import attendance records.');
                return;
            }

            // Parse file
            let data;
            if (file.name.endsWith('.csv')) {
                const text = await file.text();
                // Parse CSV manually since XLSX csv_to_sheet might not be available
                const lines = text.split('\n').filter(line => line.trim());
                data = lines.map(line => line.split(',').map(cell => cell.replace(/^"|"$/g, '').trim()));
            } else {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, blankrows: false });
            }

            console.log('Parsed attendance data length:', data.length);

            // Auto-detect columns from first row
            const headers = data[0];
            const findColumn = (names) => {
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i]?.toString().toLowerCase().trim();
                    if (header && names.some(name => header.includes(name.toLowerCase()))) {
                        return i;
                    }
                }
                return -1;
            };

            const matricCol = findColumn(['matric', 'number', 'id']);
            const timeCol = findColumn(['time', 'timestamp', 'ts']);
            const phoneCol = findColumn(['phone', 'mobile', 'contact']);
            const notesCol = findColumn(['notes', 'comment']);

            // Student info columns (only needed if updating student info)
            let facultyCol = -1, departmentCol = -1, gradeCol = -1, sourceCol = -1, nextOfKinCol = -1, lastNameCol = -1, otherNamesCol = -1;
            if (updateStudentInfo) {
                facultyCol = findColumn(['faculty']);
                departmentCol = findColumn(['department']);
                gradeCol = findColumn(['grade', 'level', 'class']);
                sourceCol = findColumn(['source']);
                nextOfKinCol = findColumn(['next', 'kin', 'guardian']);
                lastNameCol = findColumn(['last', 'surname']);
                otherNamesCol = findColumn(['other', 'first', 'given']);
            }

            if (matricCol === -1) {
                alert('Could not auto-detect required column. CSV must include at least: matric number.');
                return;
            }

            if (updateStudentInfo && lastNameCol === -1 && otherNamesCol === -1) {
                alert('For updating student info, CSV should include name columns (last name, other names).');
                return;
            }

            const progressEl = document.getElementById('attendance-import-progress');
            const progressText = document.getElementById('attendance-progress-text');
            progressEl.classList.remove('hidden');

            try {
                // Remove header
                data.shift();
                console.log('Total attendance rows after header removal:', data.length);

                // Get current operator for attendance records
                const operatorId = currentOperator?.id || '00000000-0000-0000-0000-000000000001';

                // Batch process records
                const batchSize = 500;
                let studentUpdateCount = 0;
                let attendanceImportCount = 0;
                let errorCount = 0;
                const errors = [];
                console.log('Starting batch processing...');

                for (let i = 0; i < data.length; i += batchSize) {
                    const batch = data.slice(i, i + batchSize);
                    console.log(`Processing batch ${Math.floor(i / batchSize) + 1}, rows ${i} to ${i + batch.length - 1}`);

                    const matricNumbers = batch.map(row => row[matricCol]?.toString().trim()).filter(m => m);

                    if (matricNumbers.length === 0) {
                        console.log(`Batch ${Math.floor(i / batchSize) + 1}: No valid matric numbers found, skipping`);
                        continue;
                    }

                    // Check if students exist
                    const { data: existingStudents, error: studentCheckError } = await supabase
                        .from('students')
                        .select('matric_number')
                        .eq('school_id', currentSchool.id)
                        .in('matric_number', matricNumbers);

                    if (studentCheckError) {
                        console.error('Error checking students:', studentCheckError);
                        errorCount += matricNumbers.length;
                        errors.push(`Batch ${Math.floor(i / batchSize) + 1}: Student check failed - ${studentCheckError.message}`);
                        continue;
                    }

                    const existingMatrics = new Set(existingStudents.map(s => s.matric_number));
                    console.log(`Batch ${Math.floor(i / batchSize) + 1}: Found ${existingMatrics.size} existing students out of ${matricNumbers.length}`);

                    // Update student information if enabled
                    if (updateStudentInfo) {
                        const studentUpdates = batch
                            .filter(row => {
                                const matric = row[matricCol]?.toString().trim();
                                return matric && existingMatrics.has(matric);
                            })
                            .map(row => {
                                const matric = row[matricCol]?.toString().trim();
                                const update = { matric_number: matric };

                                if (lastNameCol !== -1 && row[lastNameCol]) {
                                    update.last_name = row[lastNameCol]?.toString().trim();
                                }
                                if (otherNamesCol !== -1 && row[otherNamesCol]) {
                                    update.other_names = row[otherNamesCol]?.toString().trim();
                                }
                                if (facultyCol !== -1) {
                                    update.faculty = row[facultyCol]?.toString().trim() || null;
                                }
                                if (departmentCol !== -1) {
                                    update.department = row[departmentCol]?.toString().trim() || null;
                                }
                                if (gradeCol !== -1) {
                                    update.grade = row[gradeCol]?.toString().trim() || null;
                                }
                                if (sourceCol !== -1) {
                                    update.source = row[sourceCol]?.toString().trim() || null;
                                }
                                if (nextOfKinCol !== -1) {
                                    update.next_of_kin = row[nextOfKinCol]?.toString().trim() || null;
                                }
                                if (phoneCol !== -1) {
                                    update.phone = row[phoneCol]?.toString().trim() || null;
                                }

                                update.updated_at = new Date().toISOString();
                                return update;
                            })
                            .filter(update => Object.keys(update).length > 2); // More than just matric and updated_at

                        if (studentUpdates.length > 0) {
                            console.log(`Batch ${Math.floor(i / batchSize) + 1}: Updating ${studentUpdates.length} student records`);
                            const { error: updateError } = await supabase
                                .from('students')
                                .upsert(studentUpdates, { onConflict: 'school_id,matric_number' });

                            if (updateError) {
                                console.error(`Student update batch ${Math.floor(i / batchSize) + 1} error:`, updateError);
                                errorCount += studentUpdates.length;
                                errors.push(`Batch ${Math.floor(i / batchSize) + 1}: Student update failed - ${updateError.message}`);
                            } else {
                                studentUpdateCount += studentUpdates.length;
                                console.log(`Student update batch ${Math.floor(i / batchSize) + 1} success: ${studentUpdates.length} records`);
                            }
                        }
                    }

                    // Import attendance records if enabled
                    if (importAttendance && attendanceDate) {
                        // Get student IDs for the matric numbers in this batch
                        const matricNumbersInBatch = batch
                            .map(row => row[matricCol]?.toString().trim())
                            .filter(matric => matric && existingMatrics.has(matric));

                        if (matricNumbersInBatch.length > 0) {
                            const { data: studentsInBatch, error: studentLookupError } = await supabase
                                .from('students')
                                .select('id, matric_number')
                                .eq('school_id', currentSchool.id)
                                .in('matric_number', matricNumbersInBatch);

                            if (studentLookupError) {
                                console.error('Error looking up students:', studentLookupError);
                                errorCount += matricNumbersInBatch.length;
                                errors.push(`Batch ${Math.floor(i / batchSize) + 1}: Student lookup failed - ${studentLookupError.message}`);
                                continue;
                            }

                            const studentIdMap = new Map(studentsInBatch.map(s => [s.matric_number, s.id]));

                            const attendanceRecords = batch
                                .filter(row => {
                                    const matric = row[matricCol]?.toString().trim();
                                    return matric && studentIdMap.has(matric);
                                })
                                .map(row => {
                                    const matric = row[matricCol]?.toString().trim();
                                    return {
                                        school_id: currentSchool.id,
                                        student_id: studentIdMap.get(matric),
                                        matric_number: matric,
                                        attendance_date: attendanceDate,
                                        ts: timeCol !== -1 && row[timeCol] ? new Date(row[timeCol]).toISOString() : new Date().toISOString(),
                                        operator_id: operatorId,
                                        phone_captured: phoneCol !== -1 ? row[phoneCol]?.toString().trim() : null,
                                        notes: notesCol !== -1 ? row[notesCol]?.toString().trim() : null
                                    };
                                });

                            if (attendanceRecords.length > 0) {
                                console.log(`Batch ${Math.floor(i / batchSize) + 1}: Importing ${attendanceRecords.length} attendance records`);
                                const { error: attendanceError } = await supabase
                                    .from('attendance')
                                    .upsert(attendanceRecords, {
                                        onConflict: 'school_id,student_id,attendance_date',
                                        ignoreDuplicates: false
                                    });

                                if (attendanceError) {
                                    console.error(`Attendance import batch ${Math.floor(i / batchSize) + 1} error:`, attendanceError);
                                    errorCount += attendanceRecords.length;
                                    errors.push(`Batch ${Math.floor(i / batchSize) + 1}: Attendance import failed - ${attendanceError.message}`);
                                } else {
                                    attendanceImportCount += attendanceRecords.length;
                                    console.log(`Attendance import batch ${Math.floor(i / batchSize) + 1} success: ${attendanceRecords.length} records`);
                                }
                            }
                        }
                    }

                    // Update progress
                    const progress = Math.round((i + batch.length) / data.length * 100);
                    progressEl.querySelector('progress').value = progress;
                    progressText.textContent = `${progress}%`;
                }

                let statusMessage = `Import completed.`;
                if (updateStudentInfo) {
                    statusMessage += ` ${studentUpdateCount} student records updated.`;
                }
                if (importAttendance) {
                    statusMessage += ` ${attendanceImportCount} attendance records imported.`;
                }
                if (errorCount > 0) {
                    statusMessage += ` ${errorCount} errors.`;
                }
                document.getElementById('attendance-import-status').innerHTML = `<div class="status ${errorCount > 0 ? 'error' : 'success'}">${statusMessage}</div>`;
                if (errors.length > 0) {
                    document.getElementById('attendance-import-status').innerHTML += '<ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                }

                // Refresh dashboard data
                loadDashboardData();

            } catch (error) {
                console.error('Attendance import error:', error);
                document.getElementById('attendance-import-status').innerHTML = `<div class="status error">Import failed: ${error.message}</div>`;
            } finally {
                progressEl.classList.add('hidden');
            }
        }

        // Reports
        async function viewReport() {
            const date = document.getElementById('report-date').value;
            if (!date || !currentSchool) return;

            const { data: attendance, error } = await supabase
                .from('attendance')
                .select(`
                    matric_number,
                    phone_captured,
                    ts,
                    notes,
                    students!inner(name, faculty, department, grade, source, next_of_kin, phone),
                    operators(name)
                `)
                .eq('school_id', currentSchool.id)
                .eq('attendance_date', date)
                .order('ts', { ascending: false });

            if (error) {
                console.error('Error fetching report:', error);
                return;
            }

            const tbody = document.getElementById('report-tbody');
            tbody.innerHTML = '';

            attendance.forEach(record => {
                const attendanceTime = new Date(record.ts);
                const timeString = attendanceTime.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${record.matric_number}</code></td>
                    <td><strong>${record.students.name}</strong></td>
                    <td>${record.students.faculty || '‚Äî'}</td>
                    <td>${record.students.department || '‚Äî'}</td>
                    <td><span class="grade-badge">${record.students.grade || '‚Äî'}</span></td>
                    <td>${record.students.phone ? `<a href="tel:${record.students.phone}">${record.students.phone}</a>` : '‚Äî'}</td>
                    <td><small>${timeString}</small></td>
                    <td>${record.operators?.name || 'System'}</td>
                    <td>${record.notes || '‚Äî'}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('report-table-container').classList.remove('hidden');
        }

        async function exportDailyReport(format) {
            const date = new Date().toISOString().split('T')[0]; // Today's date

            const { data: attendance, error } = await supabase
                .from('attendance')
                .select(`
                    matric_number,
                    phone_captured,
                    ts,
                    notes,
                    students!inner(name, faculty, department, grade, source, next_of_kin, phone),
                    operators(name)
                `)
                .eq('school_id', currentSchool.id)
                .eq('attendance_date', date)
                .order('ts', { ascending: false });

            if (error) {
                console.error('Error fetching daily report:', error);
                return;
            }

            const data = attendance.map(record => ({
                Matric: record.matric_number,
                Name: record.students.name,
                Faculty: record.students.faculty || '',
                Department: record.students.department || '',
                Grade: record.students.grade || '',
                Source: record.students.source || '',
                'Next of Kin': record.students.next_of_kin || '',
                'Student Phone': record.students.phone || '',
                'Captured Phone': record.phone_captured || '',
                Time: new Date(record.ts).toLocaleString(),
                Operator: record.operators?.name || 'Unknown',
                Notes: record.notes || ''
            }));

            if (format === 'csv') {
                const csv = [Object.keys(data[0]).join(',')];
                data.forEach(row => {
                    csv.push(Object.values(row).map(v => `"${v}"`).join(','));
                });
                downloadFile(csv.join('\n'), `attendance_${date}.csv`, 'text/csv');
            } else if (format === 'xlsx') {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                XLSX.writeFile(wb, `attendance_${date}.xlsx`);
            }
        }

        async function exportReport(format) {
            const date = document.getElementById('report-date').value;
            if (!date || !currentSchool) return;

            const { data: attendance, error } = await supabase
                .from('attendance')
                .select(`
                    matric_number,
                    phone_captured,
                    ts,
                    notes,
                    students!inner(name, faculty, department, grade, source, next_of_kin, phone),
                    operators(name)
                `)
                .eq('school_id', currentSchool.id)
                .eq('attendance_date', date)
                .order('ts', { ascending: false });

            if (error) {
                console.error('Error fetching report:', error);
                return;
            }

            const data = attendance.map(record => ({
                Matric: record.matric_number,
                Name: record.students.name,
                Faculty: record.students.faculty || '',
                Department: record.students.department || '',
                Grade: record.students.grade || '',
                Source: record.students.source || '',
                'Next of Kin': record.students.next_of_kin || '',
                'Student Phone': record.students.phone || '',
                'Captured Phone': record.phone_captured || '',
                Time: new Date(record.ts).toLocaleString(),
                Operator: record.operators?.name || 'Unknown',
                Notes: record.notes || ''
            }));

            if (format === 'csv') {
                const csv = [Object.keys(data[0]).join(',')];
                data.forEach(row => {
                    csv.push(Object.values(row).map(v => `"${v}"`).join(','));
                });
                downloadFile(csv.join('\n'), `attendance_${date}.csv`, 'text/csv');
            } else if (format === 'xlsx') {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                XLSX.writeFile(wb, `attendance_${date}.xlsx`);
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Admin functions
        async function clearAllData() {
            if (!confirm('Are you sure you want to clear ALL data? This will delete all students and attendance records. This action cannot be undone!')) {
                return;
            }

            try {
                // Clear in order to avoid foreign key issues
                await supabase.from('attendance').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('students').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('operators').delete().eq('is_admin', false);

                // Recreate default operator
                await supabase.from('operators').upsert({
                    id: '00000000-0000-0000-0000-000000000001',
                    school_id: '550e8400-e29b-41d4-a716-446655440001',
                    auth_uid: '00000000-0000-0000-0000-000000000000',
                    name: 'SOLUSCIPHER',
                    is_admin: true
                });

                // Clear school name from localStorage
                localStorage.removeItem('schoolName');
                updateHeaderSchoolName('by BESTBUY INTERNATIONAL TECHNOLOGY');

                alert('All data cleared successfully. You can now import data for a new school.');
                location.reload(); // Refresh to reset counters
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('Error clearing data: ' + error.message);
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                await loadKeyMetrics();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadKeyMetrics() {
            // Total students
            const { count: totalStudents } = await supabase
                .from('students')
                .select('*', { count: 'exact', head: true })
                .eq('school_id', currentSchool.id);

            document.getElementById('total-students').textContent = totalStudents || 0;

            // Today's attendance
            const today = new Date().toISOString().split('T')[0];
            const { count: todayAttendance } = await supabase
                .from('attendance')
                .select('*', { count: 'exact', head: true })
                .eq('school_id', currentSchool.id)
                .eq('attendance_date', today);

            document.getElementById('today-attendance').textContent = todayAttendance || 0;

            // Attendance rate
            if (totalStudents > 0) {
                const rate = ((todayAttendance / totalStudents) * 100).toFixed(1);
                document.getElementById('attendance-rate').textContent = `${rate}%`;
            }

            // Top performer (placeholder)
            document.getElementById('top-performer').textContent = 'Loading...';
        }



        // Keyboard shortcuts functions
        function showShortcutsModal() {
            document.getElementById('shortcuts-modal').classList.remove('hidden');
        }

        function hideShortcutsModal() {
            document.getElementById('shortcuts-modal').classList.add('hidden');
        }

        function handleKeyboardShortcuts(e) {
            // Ignore shortcuts when typing in input fields (except specific keys)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                // Allow Ctrl+Enter in forms
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('attendance-form').dispatchEvent(new Event('submit'));
                    return;
                }
                // Allow Alt key combinations
                if (e.altKey) {
                    handleFormShortcuts(e);
                }
                return;
            }

            // Navigation shortcuts
            if (!e.ctrlKey && !e.altKey && !e.shiftKey) {
                switch (e.key) {
                    case '1':
                    case 'd':
                    case 'D':
                        e.preventDefault();
                        showSection('dashboard');
                        break;
                    case '2':
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        showSection('attendance');
                        break;
                    case '3':
                    case 'i':
                    case 'I':
                        e.preventDefault();
                        showSection('import');
                        break;
                    case '4':
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        showSection('reports');
                        break;
                    case '5':
                        e.preventDefault();
                        showSection('admin');
                        break;
                    case 'F1':
                        e.preventDefault();
                        showShortcutsModal();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        hideShortcutsModal();
                        break;
                }
            }

            // Ctrl shortcuts
            if (e.ctrlKey && !e.altKey && !e.shiftKey) {
                switch (e.key) {
                    case 'e':
                    case 'E':
                        e.preventDefault();
                        exportDailyReport('csv');
                        break;
                    case 'x':
                    case 'X':
                        e.preventDefault();
                        exportDailyReport('xlsx');
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        loadDashboardData();
                        break;
                    case 'l':
                    case 'L':
                        e.preventDefault();
                        resetAttendanceForm();
                        break;
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        showSection('admin');
                        break;
                    case '/':
                        e.preventDefault();
                        showShortcutsModal();
                        break;
                }
            }

            // Alt shortcuts for form focus
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                handleFormShortcuts(e);
            }
        }

        function handleFormShortcuts(e) {
            switch (e.key) {
                case 'm':
                case 'M':
                    e.preventDefault();
                    matricInput.focus();
                    matricInput.select();
                    break;
                case 'p':
                case 'P':
                    e.preventDefault();
                    phoneInput.focus();
                    phoneInput.select();
                    break;
            }
        }

        // Auth functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) return;

            showAuthStatus('Logging in...', 'info', 'login');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                // Auth state change will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                showAuthStatus('Login failed: ' + error.message, 'error', 'login');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = signupNameInput.value.trim();
            const username = signupUsernameInput.value.trim();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value.trim();

            if (!name || !username || !email || !password) return;

            showAuthStatus('Creating account...', 'info', 'signup');

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            username: username
                        },
                        // Disable email confirmation for easier testing
                        emailRedirectTo: window.location.origin
                    }
                });

                if (error) throw error;

                // For development, auto-confirm the user
                if (data.user && !data.user.email_confirmed_at) {
                    await supabase.auth.updateUser({
                        email_confirm: true
                    });
                }

                showAuthStatus('Account created successfully! You are now logged in.', 'success', 'signup');

                // The auth state change will handle showing the main app
            } catch (error) {
                console.error('Signup error:', error);
                showAuthStatus('Signup failed: ' + error.message, 'error', 'signup');
            }
        }

        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                // Auth state change will handle showing login
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showAuthStatus(message, type, section) {
            const statusEl = section === 'login' ? loginStatus : signupStatus;
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        function updateHeaderSchoolName(schoolName) {
            const logoSubtitle = document.querySelector('.logo-subtitle');
            if (logoSubtitle) {
                logoSubtitle.textContent = schoolName;
            }
        }

        // Add student modal functions
        function showAddStudentModal() {
            addStudentModal.classList.remove('hidden');
        }

        function hideAddStudentModal() {
            addStudentModal.classList.add('hidden');
            addStudentForm.reset();
            addStudentStatus.classList.add('hidden');
        }

        async function handleAddStudent(e) {
            e.preventDefault();

            const matric = document.getElementById('new-matric').value.trim();
            const lastName = document.getElementById('new-last-name').value.trim();
            const otherNames = document.getElementById('new-other-names').value.trim();
            const faculty = document.getElementById('new-faculty').value.trim();
            const department = document.getElementById('new-department').value.trim();
            const grade = document.getElementById('new-grade').value.trim();
            const source = document.getElementById('new-source').value.trim();
            const nextOfKin = document.getElementById('new-next-of-kin').value.trim();
            const phone = document.getElementById('new-phone').value.trim();

            if (!matric || !lastName || !otherNames || !phone) {
                showAddStudentStatus('Please fill in matric number, name, and phone number.', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('students')
                    .insert({
                        school_id: currentSchool.id,
                        matric_number: matric,
                        last_name: lastName,
                        other_names: otherNames,
                        faculty: faculty || null,
                        department: department || null,
                        grade: grade || null,
                        source: source || null,
                        next_of_kin: nextOfKin || null,
                        phone: phone
                    });

                if (error) throw error;

                showAddStudentStatus('Student added successfully!', 'success');

                // Refresh student data in the form
                setTimeout(() => {
                    hideAddStudentModal();
                    handleMatricInput(); // Re-fetch student data
                }, 1500);

            } catch (error) {
                console.error('Error adding student:', error);
                showAddStudentStatus('Error adding student: ' + error.message, 'error');
            }
        }

        function showAddStudentStatus(message, type) {
            addStudentStatus.textContent = message;
            addStudentStatus.className = `status ${type}`;
            addStudentStatus.classList.remove('hidden');
            setTimeout(() => addStudentStatus.classList.add('hidden'), 5000);
        }

        // Edit student modal functions
        function showEditStudentModal() {
            const matric = editStudentBtn.dataset.matric;
            if (!matric) return;

            // Fetch current student data
            supabase
                .from('students')
                .select('*')
                .eq('school_id', currentSchool.id)
                .eq('matric_number', matric)
                .single()
                .then(({ data: student, error }) => {
                    if (error) {
                        console.error('Error fetching student:', error);
                        return;
                    }

                    // Populate form
                    document.getElementById('edit-matric').value = student.matric_number;
                    document.getElementById('edit-last-name').value = student.last_name;
                    document.getElementById('edit-other-names').value = student.other_names;
                    document.getElementById('edit-faculty').value = student.faculty || '';
                    document.getElementById('edit-department').value = student.department || '';
                    document.getElementById('edit-grade').value = student.grade || '';
                    document.getElementById('edit-source').value = student.source || '';
                    document.getElementById('edit-phone').value = student.phone || '';
                    document.getElementById('edit-next-of-kin').value = student.next_of_kin || '';

                    editStudentModal.classList.remove('hidden');
                });
        }

        function hideEditStudentModal() {
            editStudentModal.classList.add('hidden');
            editStudentForm.reset();
            editStudentStatus.classList.add('hidden');
        }

        async function handleEditStudent(e) {
            e.preventDefault();

            const matric = document.getElementById('edit-matric').value.trim();
            const lastName = document.getElementById('edit-last-name').value.trim();
            const otherNames = document.getElementById('edit-other-names').value.trim();
            const faculty = document.getElementById('edit-faculty').value.trim();
            const department = document.getElementById('edit-department').value.trim();
            const grade = document.getElementById('edit-grade').value.trim();
            const source = document.getElementById('edit-source').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const nextOfKin = document.getElementById('edit-next-of-kin').value.trim();

            if (!matric || !lastName || !otherNames || !phone) {
                showEditStudentStatus('Please fill in matric number, name, and phone number.', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('students')
                    .update({
                        last_name: lastName,
                        other_names: otherNames,
                        faculty: faculty || null,
                        department: department || null,
                        grade: grade || null,
                        source: source || null,
                        phone: phone,
                        next_of_kin: nextOfKin || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('school_id', currentSchool.id)
                    .eq('matric_number', matric);

                if (error) throw error;

                showEditStudentStatus('Student updated successfully!', 'success');

                // Refresh student data in the form
                setTimeout(() => {
                    hideEditStudentModal();
                    handleMatricInput(); // Re-fetch student data
                }, 1500);

            } catch (error) {
                console.error('Error updating student:', error);
                showEditStudentStatus('Error updating student: ' + error.message, 'error');
            }
        }

        function showEditStudentStatus(message, type) {
            editStudentStatus.textContent = message;
            editStudentStatus.className = `status ${type}`;
            editStudentStatus.classList.remove('hidden');
            setTimeout(() => editStudentStatus.classList.add('hidden'), 5000);
        }

        function showCompleteStudentModal(student, phone) {
            document.getElementById('complete-student-name').textContent = `${student.other_names} ${student.last_name}`;
            document.getElementById('complete-matric').value = student.matric_number;

            // Pre-fill with existing data if available
            document.getElementById('complete-faculty').value = student.faculty || '';
            document.getElementById('complete-department').value = student.department || '';
            document.getElementById('complete-grade').value = student.grade || '';
            document.getElementById('complete-source').value = student.source || '';
            document.getElementById('complete-next-of-kin').value = student.next_of_kin || '';
            document.getElementById('complete-phone').value = phone || student.phone || '';

            // Store additional data for later use
            completeStudentModal._phone = phone;

            completeStudentModal.classList.remove('hidden');
        }

        function hideCompleteStudentModal() {
            completeStudentModal.classList.add('hidden');
            completeStudentForm.reset();
            completeStudentStatus.classList.add('hidden');
        }

        async function handleCompleteStudentAndMarkAttendance(e) {
            e.preventDefault();

            const matric = document.getElementById('complete-matric').value;
            const faculty = document.getElementById('complete-faculty').value.trim();
            const department = document.getElementById('complete-department').value.trim();
            const grade = document.getElementById('complete-grade').value.trim();
            const source = document.getElementById('complete-source').value.trim();
            const nextOfKin = document.getElementById('complete-next-of-kin').value.trim();
            const phone = document.getElementById('complete-phone').value.trim();

            if (!faculty || !department || !grade || !source || !nextOfKin || !phone) {
                showCompleteStudentStatus('Please fill in all required fields, including phone number.', 'error');
                return;
            }

            try {
                // Update student information
                const { error: updateError } = await supabase
                    .from('students')
                    .update({
                        faculty: faculty,
                        department: department,
                        grade: grade,
                        source: source,
                        next_of_kin: nextOfKin,
                        phone: phone || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('school_id', currentSchool.id)
                    .eq('matric_number', matric);

                if (updateError) throw updateError;

                // Mark attendance
                await markAttendance(matric, phone, completeStudentModal._notes);
                hideCompleteStudentModal();

            } catch (error) {
                console.error('Error completing student info:', error);
                showCompleteStudentStatus('Error updating student: ' + error.message, 'error');
            }
        }

        async function handleSkipCompleteAndMarkAttendance() {
            const matric = document.getElementById('complete-matric').value;
            const phone = completeStudentModal._phone;

            if (!phone) {
                showCompleteStudentStatus('Phone number is required to mark attendance.', 'error');
                return;
            }

            await markAttendance(matric, phone, completeStudentModal._notes);
            hideCompleteStudentModal();
        }

        async function markAttendance(matric, phone, notes) {
            markBtn.disabled = true;
            markBtn.innerHTML = '<div class="loading"></div> Marking...';

            try {
                // Update student phone number if provided
                if (phone) {
                    await supabase
                        .from('students')
                        .update({ phone: phone, updated_at: new Date().toISOString() })
                        .eq('school_id', currentSchool.id)
                        .eq('matric_number', matric);
                }

                const { data, error } = await supabase.rpc('mark_attendance', {
                    p_school_id: currentSchool.id,
                    p_matric: matric,
                    p_date: new Date().toISOString().split('T')[0],
                    p_operator_id: currentOperator.id,
                    p_phone: phone || null,
                    p_notes: notes || null
                });

                if (error) throw error;

                showStatus('‚úÖ Attendance marked successfully!', 'success');
                resetAttendanceForm();

                // Refresh dashboard data
                loadDashboardData();
            } catch (error) {
                console.error('Error marking attendance:', error);
                showStatus('‚ùå Error marking attendance: ' + error.message, 'error');
            } finally {
                markBtn.disabled = false;
                markBtn.textContent = 'Mark Attendance';
            }
        }

        function showCompleteStudentStatus(message, type) {
            completeStudentStatus.textContent = message;
            completeStudentStatus.className = `status ${type}`;
            completeStudentStatus.classList.remove('hidden');
            setTimeout(() => completeStudentStatus.classList.add('hidden'), 5000);
        }

        // Advanced Export Functions
        function showAdvancedExportModal() {
            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('export-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('export-end-date').value = endDate.toISOString().split('T')[0];

            // Load filter options
            loadExportFilters();

            advancedExportModal.classList.remove('hidden');
        }

        function hideAdvancedExportModal() {
            advancedExportModal.classList.add('hidden');
            advancedExportForm.reset();
            advancedExportStatus.classList.add('hidden');
            exportProgress.classList.add('hidden');
        }

        function showExportTemplatesModal() {
            exportTemplatesModal.classList.remove('hidden');
        }

        function hideExportTemplatesModal() {
            exportTemplatesModal.classList.add('hidden');
            document.getElementById('templates-status').classList.add('hidden');
        }

        async function loadExportFilters() {
            try {
                // Load faculties
                const { data: faculties } = await supabase
                    .from('students')
                    .select('faculty')
                    .eq('school_id', currentSchool.id);

                const facultySelect = document.getElementById('export-faculty');
                const uniqueFaculties = [...new Set(faculties.map(f => f.faculty).filter(f => f))];
                facultySelect.innerHTML = '<option value="">All Faculties</option>';
                uniqueFaculties.forEach(faculty => {
                    facultySelect.innerHTML += `<option value="${faculty}">${faculty}</option>`;
                });

                // Load departments
                const { data: departments } = await supabase
                    .from('students')
                    .select('department')
                    .eq('school_id', currentSchool.id);

                const deptSelect = document.getElementById('export-department');
                const uniqueDepts = [...new Set(departments.map(d => d.department).filter(d => d))];
                deptSelect.innerHTML = '<option value="">All Departments</option>';
                uniqueDepts.forEach(dept => {
                    deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
                });

                // Load grades
                const { data: grades } = await supabase
                    .from('students')
                    .select('grade')
                    .eq('school_id', currentSchool.id);

                const gradeSelect = document.getElementById('export-grade');
                const uniqueGrades = [...new Set(grades.map(g => g.grade).filter(g => g))];
                gradeSelect.innerHTML = '<option value="">All Grades</option>';
                uniqueGrades.forEach(grade => {
                    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
                });

                // Load operators
                const { data: operators } = await supabase
                    .from('operators')
                    .select('id, name')
                    .eq('school_id', currentSchool.id);

                const operatorSelect = document.getElementById('export-operator');
                operatorSelect.innerHTML = '<option value="">All Operators</option>';
                operators.forEach(op => {
                    operatorSelect.innerHTML += `<option value="${op.id}">${op.name}</option>`;
                });

            } catch (error) {
                console.error('Error loading export filters:', error);
            }
        }

        async function handleAdvancedExport(e) {
            e.preventDefault();

            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            const faculty = document.getElementById('export-faculty').value;
            const department = document.getElementById('export-department').value;
            const grade = document.getElementById('export-grade').value;
            const operator = document.getElementById('export-operator').value;
            const format = document.getElementById('export-format').value;
            const groupBy = document.getElementById('export-group-by').value;
            const includeSummary = document.getElementById('export-include-summary').checked;
            const anonymous = document.getElementById('export-anonymous').checked;

            if (!startDate || !endDate) {
                showAdvancedExportStatus('Please select date range.', 'error');
                return;
            }

            exportProgress.classList.remove('hidden');
            exportProgressText.textContent = 'Fetching data...';

            try {
                // Build query
                let query = supabase
                    .from('attendance')
                    .select(`
                        matric_number,
                        attendance_date,
                        ts,
                        phone_captured,
                        notes,
                        students!inner(name, faculty, department, grade, source, next_of_kin, phone),
                        operators(name, username)
                    `)
                    .eq('school_id', currentSchool.id)
                    .gte('attendance_date', startDate)
                    .lte('attendance_date', endDate)
                    .order('attendance_date', { ascending: false })
                    .order('ts', { ascending: false });

                // Apply filters
                if (faculty) {
                    query = query.eq('students.faculty', faculty);
                }
                if (department) {
                    query = query.eq('students.department', department);
                }
                if (grade) {
                    query = query.eq('students.grade', grade);
                }
                if (operator) {
                    query = query.eq('operator_id', operator);
                }

                exportProgressText.textContent = 'Processing data...';
                const { data: attendance, error } = await query;

                if (error) throw error;

                exportProgressText.textContent = 'Generating export...';

                // Process data
                let processedData = attendance.map(record => ({
                    Date: record.attendance_date,
                    Time: new Date(record.ts).toLocaleString(),
                    'Matric Number': record.matric_number,
                    'Student Name': anonymous ? 'Anonymous' : record.students.name,
                    Faculty: record.students.faculty || '',
                    Department: record.students.department || '',
                    Grade: record.students.grade || '',
                    Source: record.students.source || '',
                    'Next of Kin': anonymous ? '' : record.students.next_of_kin || '',
                    'Student Phone': anonymous ? '' : record.students.phone || '',
                    'Captured Phone': record.phone_captured || '',
                    Operator: record.operators?.name || 'Unknown',
                    'Operator Username': record.operators?.username || '',
                    Notes: record.notes || ''
                }));

                // Group data if requested
                if (groupBy !== 'none') {
                    processedData = groupDataBy(processedData, groupBy);
                }

                // Generate export based on format
                const filename = `attendance_export_${startDate}_to_${endDate}`;

                if (format === 'csv') {
                    exportToCSV(processedData, filename);
                } else if (format === 'xlsx') {
                    exportToXLSX(processedData, filename, includeSummary, startDate, endDate);
                }

                exportProgressText.textContent = 'Export completed!';
                setTimeout(() => {
                    hideAdvancedExportModal();
                }, 2000);

            } catch (error) {
                console.error('Advanced export error:', error);
                showAdvancedExportStatus('Export failed: ' + error.message, 'error');
                exportProgress.classList.add('hidden');
            }
        }

        function groupDataBy(data, groupBy) {
            const groups = {};
            data.forEach(record => {
                const key = record[groupBy.charAt(0).toUpperCase() + groupBy.slice(1)] || 'Unknown';
                if (!groups[key]) groups[key] = [];
                groups[key].push(record);
            });

            const result = [];
            Object.keys(groups).sort().forEach(key => {
                result.push({ [groupBy.toUpperCase()]: key, '': '' });
                result.push(...groups[key]);
                result.push({ '': '', 'TOTAL': groups[key].length + ' records' });
            });

            return result;
        }

        function exportToCSV(data, filename) {
            const csv = [Object.keys(data[0]).join(',')];
            data.forEach(row => {
                csv.push(Object.values(row).map(v => `"${v}"`).join(','));
            });
            downloadFile(csv.join('\n'), `${filename}.csv`, 'text/csv');
        }

        function exportToXLSX(data, filename, includeSummary, startDate, endDate) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Data');

            if (includeSummary) {
                const summaryData = generateSummaryData(data, startDate, endDate);
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            }

            XLSX.writeFile(wb, `${filename}.xlsx`);
        }

        function generateSummaryData(data, startDate, endDate) {
            const summary = {
                'Report Period': `${startDate} to ${endDate}`,
                'Total Records': data.length,
                'Unique Students': [...new Set(data.map(r => r['Matric Number']))].length,
                'Date Range': `${Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24))} days`
            };

            // Faculty breakdown
            const facultyStats = {};
            data.forEach(record => {
                const faculty = record.Faculty || 'Unknown';
                facultyStats[faculty] = (facultyStats[faculty] || 0) + 1;
            });

            summary['Faculty Breakdown'] = Object.entries(facultyStats)
                .map(([faculty, count]) => `${faculty}: ${count}`)
                .join(', ');

            return [summary];
        }

        async function exportTemplate(templateType) {
            const today = new Date().toISOString().split('T')[0];
            let startDate, endDate, filters = {};

            switch (templateType) {
                case 'daily-report':
                    startDate = endDate = today;
                    break;
                case 'weekly-summary':
                    endDate = today;
                    startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'faculty-report':
                    endDate = today;
                    startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'operator-performance':
                    endDate = today;
                    startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'absentee-list':
                    startDate = endDate = today;
                    break;
                case 'late-arrivals':
                    startDate = endDate = today;
                    break;
            }

            // Set form values
            document.getElementById('export-start-date').value = startDate;
            document.getElementById('export-end-date').value = endDate;
            document.getElementById('export-format').value = 'xlsx';
            document.getElementById('export-group-by').value = templateType.includes('faculty') ? 'faculty' :
                templateType.includes('operator') ? 'operator' : 'none';
            document.getElementById('export-include-summary').checked = true;

            // Hide templates modal and show advanced export
            hideExportTemplatesModal();
            showAdvancedExportModal();

            // Show status
            const statusEl = document.getElementById('templates-status');
            statusEl.textContent = `Template "${templateType.replace('-', ' ')}" loaded. Configure additional options and click "Generate Export".`;
            statusEl.className = 'status success';
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }

        function showAdvancedExportStatus(message, type) {
            advancedExportStatus.textContent = message;
            advancedExportStatus.className = `status ${type}`;
            advancedExportStatus.classList.remove('hidden');
            setTimeout(() => advancedExportStatus.classList.add('hidden'), 5000);
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Initialize
        init();
    </script>
</body>

</html>